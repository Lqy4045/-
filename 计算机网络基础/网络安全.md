# 网络安全

## 同源策略

同源指的是 `协议` `域名` `端口`相同的一个网址，浏览器默认两个同源之间可以相互操作访问资源与 DOM 操作，如果不是同源，则会有一套同源策略所制约，这套规则就是同源的策略。

`http` 默认端口是 80
`https` 默认端口是 443

## 网络攻击

### XSS

跨站脚本攻击。指的是攻击者向网页注入恶意的客户端代码，通过恶意的脚本对客户端网页进行篡改，从而在用户浏览网页时，对用户浏览器进行控制或者获取用户隐私数据的一种攻击方式。

1. 示例：

- 可以窃取 `Cookie` 信息。恶意 JavaScript 可以通过 `document.cookie` 获取 `Cookie` 信息，然后通过 `XMLHttpRequest` 或者 `Fetch` 加上 `CORS` 功能将数据发送给恶意服务器。恶意服务器拿到用户的 `Cookie` 信息之后，就可以在其他电脑上模拟用户的登录，然后进行转账等操作。
- 可以监听用户行为。恶意 JavaScript 可以使用 `addEventListener` 接口来监听键盘事件，比如可以获取用户输入的信用卡等信息，将其发送到恶意服务器。黑客掌握了这些信息之后，又可以做很多违法的事情。
- 可以通过修改 DOM 伪造假的登录窗口，用来欺骗用户输入用户名和密码等信息。
- 可以在页面内生成浮窗广告，这些广告会严重地影响用户体验。

2. XSS 攻击类型

- **存储型**：即攻击被存储在服务端，常见的是在评论区插入攻击脚本，如果脚本被储存到服务端，那么所有看见对应评论的用户都会受到攻击。例如 2015 年喜马拉雅的专辑名称允许用户编写 `<script>` 标签。
- **反射型**：攻击者将脚本混在 URL 里，服务端接收到 URL 将恶意代码当做参数取出并拼接在 HTML 里返回，浏览器解析此 HTML 后即执行恶意代码。例如 Q 群或者邮件中发送恶意链接，用户点击恶意链接，然后解析 URL 执行恶意代码。
- **DOM(文档) 型**：攻击者通过各种手段将恶意脚本注入用户的页面中。例如通过网络劫持（WiFi 路由器劫持、本地恶意软件劫持等）在页面传输过程中修改 HTML 页面内容。

3. XSS 防范措施

- **输入检查**：对输入内容中的 `script` 和 `<iframe>` 等标签进行转义或者过滤
- **设置 httpOnly**：设置此属性可防止 JavaScript 获取 `Cookie`，只能在 HTTP 请求过程中使用 `Cookie`
- **开启 CSP 白名单**：即开启白名单，可阻止白名单以外的资源加载和运行

### CSRF

跨站点请求伪造，指的是以你的名义发送请求，进行一系列操作。CSRF 攻击就是黑客利用用户的登录状态，并通过第三方的站点来做一些坏事。如发送邮件，发送短信，购买一些东西等等

1. CSRF 攻击方式

- **自动发起 Get 请求**

```html
<!DOCTYPE html>
<html>
  <body>
    <h1>黑客的站点：CSRF 攻击演示</h1>
    <img src="https://jsliang.top/index.html?user=hacker&number=100" />
  </body>
</html>
```

黑客将转账的请求接口隐藏在 `img` 标签内，欺骗浏览器这是一张图片资源。

当该页面被加载时，浏览器会自动发起 `img` 的资源请求，如果服务器没有对该请求做判断的话，那么服务器就会认为该请求是一个转账请求，于是用户账户上的 100 块就被转移到黑客的账户上去了。

- **自动发起 POST 请求**

```html
<!DOCTYPE html>
<html>
  <body>
    <h1>黑客的站点：CSRF 攻击演示</h1>
    <form id="hacker-form" action="https://jsliang.top" method="POST">
      <input type="hidden" name="user" value="hacker" />
      <input type="hidden" name="number" value="100" />
    </form>
    <script>
      document.getElementById('hacker-form').submit()
    </script>
  </body>
</html>
```

在页面中构建了一个隐藏的表单，该表单的内容就是极客时间的转账接口。

当用户打开该站点之后，这个表单会被自动执行提交；当表单被提交之后，服务器就会执行转账操作。

因此使用构建自动提交表单这种方式，就可以自动实现跨站点 POST 数据提交。

- **引诱用户点击链接**

```html
<div><img width=150 src=http://images.xuejuzi.cn/1612/1_161230185104_1.jpg></div>
<div>
  <a href="https://jsliang.top?user=hacker&number=100" taget="_blank"> 点击下载美女照片 </a>
</div>
```

传说中的色诱，或者 “点击即送 100w 元” 之类的。

2. CSRF 防范措施

- **验证 Token**：浏览器请求服务器时，服务器返回一个 `token`，之后每个请求都需要同时带上 `token` 和 `Cookie` 才会被认为是合法请求
- **验证 Referer**：通过验证请求头的 `Referer` 来验证来源站点，但请求头很容易伪造
- **设置 SameSite**：设置 `Cookie` 的 `SameSite`，可以让 `Cookie` 不随跨站请求发出，但浏览器兼容不一

### 流量劫持

流量劫持基本分两种：DNS 劫持 和 HTTP 劫持，目的都是一样的，就是当用户访问 `github.com` 的时候，给你展示的并不是或者不完全是 `github.com` 提供的 “内容”。

1. DNS 劫持

当用户通过某一个域名访问一个站点的时候，被篡改的 DNS 服务器返回的是一个恶意的钓鱼站点的 IP，用户就被劫持到了恶意钓鱼站点，然后继而会被钓鱼输入各种账号密码信息，泄漏隐私。

这类劫持：

- 要不就是网络运营商搞的鬼，一般小的网络运营商与黑产勾结会劫持 DNS
- 要不就是电脑中毒，被恶意篡改了路由器的 DNS 配置，基本上做为开发者或站长却是很难察觉的，除非有用户反馈。

2. HTTP 劫持

HTTP 劫持主要是当用户访问某个站点的时候会经过运营商网络，而不法运营商和黑产勾结能够截获 HTTP 请求返回内容，并且能够篡改内容，然后再返回给用户，从而实现劫持页面。

轻则插入小广告，重则直接篡改成钓鱼网站页面骗用户隐私，就好比 **jsliang** 访问某 `XXDN` 网站，会出现 Google 广告，实际上问了其他人的是不会有这个的。

能够实施流量劫持的根本原因，是 HTTP 协议没有办法对通信对方的身份进行校验以及对数据完整性进行校验。如果能解决这个问题，则流量劫持将无法轻易发生。

所以防止 HTTP 劫持的方法只有将内容加密，让劫持者无法破解篡改，这样就可以防止 HTTP 劫持了。

HTTPS 是基于 SSL 协议的安全加密网络应用层协议，相当于 HTTP + SSL，可以很好地防止 HTTP 劫持。

## 浏览器的网路安全

HTTP 在传输过程中的每一个环节，数据都有可能被窃取或者篡改，这也意味着你和服务器之间还可能有个中间人，在通信过程中的一切内容都在中间人的掌握中。

使用 HTTP 传输的内容很容易被中间人窃取、伪造和篡改，通常我们把这种攻击方式称为中间人攻击。

具体来讲，在将 HTTP 数据提交给 TCP 层之后，数据会经过用户电脑、WiFi 路由器、运营商和目标服务器，在这中间的每个环节中，数据都有可能被窃取或篡改。

比如用户电脑被黑客安装了恶意软件，那么恶意软件就能抓取和篡改所发出的 HTTP 请求的内容。

或者用户一不小心连接上了 WiFi 钓鱼路由器，那么数据也都能被黑客抓取或篡改。

## 浏览器系统安全

HTTP 在传输过程中的每一个环节，数据都有可能被窃取或者篡改，这也意味着你和服务器之间还可能有个中间人，在通信过程中的一切内容都在中间人的掌握中。

使用 HTTP 传输的内容很容易被中间人窃取、伪造和篡改，通常我们把这种攻击方式称为中间人攻击。

具体来讲，在将 HTTP 数据提交给 TCP 层之后，数据会经过用户电脑、WiFi 路由器、运营商和目标服务器，在这中间的每个环节中，数据都有可能被窃取或篡改。

比如用户电脑被黑客安装了恶意软件，那么恶意软件就能抓取和篡改所发出的 HTTP 请求的内容。

或者用户一不小心连接上了 WiFi 钓鱼路由器，那么数据也都能被黑客抓取或篡改。

## 浏览器系统安全

> [返回目录](#chapter-one)

浏览器本身的漏洞是单进程浏览器的一个主要问题，如果浏览器被曝出存在漏洞，那么在这些漏洞没有被及时修复的情况下，黑客就有可能通过恶意的页面向浏览器中注入恶意程序。

其中最常见的攻击方式是利用缓冲区溢出，不过需要注意这种类型的攻击和 XSS 注入的脚本是不一样的。

- XSS 攻击只是将恶意的 JavaScript 脚本注入到页面中，虽然能窃取一些 `Cookie` 相关的数据，但是 XSS 无法对操作系统进行攻击。
- 通过浏览器漏洞进行的攻击是可以入侵到浏览器进程内部的，可以读取和修改浏览器进程内部的任意内容，还可以穿透浏览器，在用户的操作系统上悄悄地安装恶意软件、监听用户键盘输入信息以及读取用户硬盘上的文件内容。

渲染进程需要执行 DOM 解析、CSS 解析、网络图片解码等操作，如果渲染进程中存在系统级别的漏洞，那么以上操作就有可能让恶意的站点获取到渲染进程的控制权限，进而又获取操作系统的控制权限。

基于此，在渲染进程和操作系统之间建一道墙，即便渲染进程由于存在漏洞被黑客攻击，但由于这道墙，黑客就获取不到渲染进程之外的任何操作权限。

将渲染进程和操作系统隔离的这道墙就是安全沙箱。

## 参考文献

- [x] [常见 Web 安全攻防总结](https://zoumiaojiang.com/article/common-web-security/)【阅读建议：1h】
- [x] [前端安全系列（一）：如何防止 XSS 攻击？](https://tech.meituan.com/2018/09/27/fe-security.html)【阅读建议：20min】
- [x] [前端安全系列（二）：如何防止 CSRF 攻击？](https://tech.meituan.com/2018/10/11/fe-security-csrf.html)【阅读建议：20min】
- [x] [前端也需要了解的 JSONP 安全](https://juejin.im/post/5b75b497e51d45666276251d)【阅读建议：10min】
- [x] [【面试篇】寒冬求职之你必须要懂的 Web 安全](https://juejin.im/post/5cd6ad7a51882568d3670a8e)【阅读建议：20min】
- [x] [谈谈对 Web 安全的理解](https://zhuanlan.zhihu.com/p/25486768?group_id=820705780520079360)【阅读建议：10min】
- [x] [程序员必须要了解的 web 安全](https://juejin.im/post/5b4e0c936fb9a04fcf59cb79)【阅读建议：10min】
- [x] [可信前端之路：代码保护](https://www.freebuf.com/articles/web/102269.html)【阅读建议：10min】
- [x] [前端如何给 JavaScript 加密（不是混淆）？](https://www.zhihu.com/question/47047191)【阅读建议：10min】
